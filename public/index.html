<!DOCTYPE html>
<html>
<head>
  <title>Talk to GPT</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: 'Comfortaa';
      font-size: 24px;
      color: #FFE6C7;
      background-color: #454545;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      position: relative;
      top: 0px;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 20px;
      height: 100%;
      overflow-y: auto;
    }

    .system-message-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      width: 95%;
      padding: 0 20px;
    }

    .system-message-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #FFA559;
      border-radius: 5px;
      font-size: 14px;
      background-color: #454545;
      color: #FFE6C7;
      outline: none;
      resize: none;
      overflow: hidden;
    }

    .voice-control-container {
      display: flex;
      align-items: center;
      margin-left: 10px;
    }
    .custom-checkbox {
      position: relative;
      width: 18px;
      height: 18px;
      border: 2px solid #FFA559;
      border-radius: 3px;
      background-color: #454545;
      cursor: pointer;
    }
    .custom-checkbox.checked::before {
      content: "";
      position: absolute;
      top: 4px;
      left: 4px;
      width: 10px;
      height: 10px;
      background-color: #FFA559;
      border-radius: 2px;
    }
    .voice-checkbox-label {
      color: #FFE6C7;
      margin: 5px;
      font-size: 14px;
    }
    #voiceCheckbox {
      display: none;
    }
    #voiceSelect {
      height: 3em;
      width: 100px;
      margin: 5px;
      padding: 5px;
      border: 2px solid #FFA559;
      border-radius: 5px;
      font-size: 14px;
      background-color: #454545;
      color: #FFE6C7;
      outline: none;
    }

  </style>
</head>
<body>
  <div class="system-message-container">
    <textarea id="system-message" class="system-message-input" rows="1">You are VoiceGPT, a voice powered assistant. Current date: 2023-04-06</textarea>

    <div class="voice-control-container">
      <select id="voiceSelect" style="display: none;"></select>
      <label class="voice-checkbox-label" for="voiceCheckbox">Voice</label>
      <div class="custom-checkbox" id="customCheckbox"></div>
      <input type="checkbox" id="voiceCheckbox">
    </div>
  </div>
  <div id="transcript" class="container"></div>

  <script>
    // Connect to the socket.io server
    const socket = io();

    // Function to scroll the specified element to the bottom
    function scrollToBottom(element) {
      element.scrollTop = element.scrollHeight;
    }

    const transcript = document.getElementById('transcript');
    const systemMessageInput = document.getElementById('system-message');

    systemMessageInput.addEventListener('change', () => {
      socket.emit('changeSystemMsg', systemMessageInput.value);
    });

    // Function to populate the voice selection dropdown with available voices
    function populateVoiceList() {
      const voiceSelect = document.getElementById('voiceSelect');
      const voices = window.speechSynthesis.getVoices();
      voices.forEach((voice) => {
        const option = document.createElement('option');
        option.textContent = voice.name;
        option.value = voice.name;
        voiceSelect.appendChild(option);
      });
    }

    // Function to convert text to speech using the SpeechSynthesis API
    function speakText(text) {
      const synth = window.speechSynthesis;
      const utterance = new SpeechSynthesisUtterance(text);
      const voiceCheckbox = document.getElementById('voiceCheckbox');
      const voiceSelect = document.getElementById('voiceSelect');
      if (voiceCheckbox.checked) {
        const selectedVoiceName = voiceSelect.value;
        const voices = synth.getVoices();
        const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
        utterance.voice = selectedVoice;
      }
      synth.speak(utterance);
    }

    const customCheckbox = document.getElementById('customCheckbox');
    const voiceCheckbox = document.getElementById('voiceCheckbox');
    const voiceSelect = document.getElementById('voiceSelect');
    customCheckbox.addEventListener('click', () => {
      voiceCheckbox.checked = !voiceCheckbox.checked;
      customCheckbox.classList.toggle('checked', voiceCheckbox.checked);
      voiceSelect.style.display = voiceCheckbox.checked ? 'block' : 'none';
    });

    function autoResize(element) {
      element.style.height = 'auto';
      element.style.height = (element.scrollHeight) + 'px';
      var viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

      // Set maximum height of transcript element
      var transcript = document.getElementById("transcript");
      var maxHeight = viewportHeight - element.offsetHeight - 40;
      transcript.style.maxHeight = maxHeight + "px";
      transcript.style.overflowY = "scroll";
    }

    systemMessageInput.addEventListener('input', () => {
      autoResize(systemMessageInput);
    });

    // Call autoResize once to set initial height
    autoResize(systemMessageInput);


    var lastResponse = document.createElement('p');
    transcript.appendChild(lastResponse);

    socket.on('append', (data) =>{
      if(data == "ENDING"){
        lastResponse = document.createElement('p');
        transcript.appendChild(lastResponse);
      } else {
        lastResponse.textContent = lastResponse.textContent + data;
      }
      scrollToBottom(transcript);
    });


    // Initialize SpeechRecognition API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
      const speechResult = event.results[0][0].transcript;
      socket.emit('speechResult', speechResult);
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
    };

    recognition.onend = () => {
      recognition.start();
    };

    recognition.start();

    // Update the transcript and response history whenever there is new data from the server
    socket.on('update', (messageHistory) => {
      transcript.innerHTML = '';

      // Display messageHistory
      messageHistory.forEach(message => {
        const messageElement = document.createElement('p');
        messageElement.textContent = `${message.role}: ${message.content}`;
        transcript.appendChild(messageElement);
      });

    // Get the last message from the messageHistory
    const lastMessage = messageHistory[messageHistory.length - 1];

    // If the last message is from the assistant, convert it to speech
    if (lastMessage && lastMessage.role === 'assistant') {
      speakText(lastMessage.content);
    }

      // Scroll the transcript div to the bottom
      scrollToBottom(transcript);
    });


    // Populate the voice selection dropdown
    populateVoiceList();
    // If the browser's voices change (e.g., due to a new voice being added), repopulate the voice selection dropdown
    window.speechSynthesis.onvoiceschanged = populateVoiceList;

  </script>

</body>
</html>
