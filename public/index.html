<!DOCTYPE html>
<html>
<head>
  <title>Talk to GPT</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: 'Comfortaa';
      font-size: 24px;
      color: #FFE6C7;
      background-color: #454545;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      position: relative;
      top: 0px;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 20px;
      height: 100%;
      overflow-y: auto;
    }

    .system-message-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      width: 90%;
      padding: 0 20px;
    }

    .system-message-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #FFA559;
      border-radius: 5px;
      font-size: 14px;
      background-color: #454545;
      color: #FFE6C7;
      outline: none;
      resize: none;
      overflow: hidden;
    }

  </style>
</head>
<body>
  <div class="system-message-container">
    <textarea id="system-message" class="system-message-input" rows="1">You are VoiceGPT, a voice powered assistant. Current date: 2023-04-06</textarea>
  </div>
  <div id="transcript" class="container"></div>

  <script>
    // Connect to the socket.io server
    const socket = io();

    // Function to scroll the specified element to the bottom
    function scrollToBottom(element) {
      element.scrollTop = element.scrollHeight;
    }

    const transcript = document.getElementById('transcript');
    const systemMessageInput = document.getElementById('system-message');

    systemMessageInput.addEventListener('change', () => {
      socket.emit('changeSystemMsg', systemMessageInput.value);
    });

    function autoResize(element) {
      element.style.height = 'auto';
      element.style.height = (element.scrollHeight) + 'px';
      var viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

      // Set maximum height of transcript element
      var transcript = document.getElementById("transcript");
      var maxHeight = viewportHeight - element.offsetHeight - 40;
      transcript.style.maxHeight = maxHeight + "px";
      transcript.style.overflowY = "scroll";
    }

    systemMessageInput.addEventListener('input', () => {
      autoResize(systemMessageInput);
    });

    // Call autoResize once to set initial height
    autoResize(systemMessageInput);


    var lastResponse = document.createElement('p');
    transcript.appendChild(lastResponse);

    socket.on('append', (data) =>{
      if(data == "ENDING"){
        lastResponse = document.createElement('p');
        transcript.appendChild(lastResponse);
      } else {
        lastResponse.textContent = lastResponse.textContent + data;
      }
      scrollToBottom(transcript);
    });

    // Update the transcript and response history whenever there is new data from the server
    socket.on('update', (messageHistory) => {
      transcript.innerHTML = '';

      // Display messageHistory
      messageHistory.forEach(message => {
        const messageElement = document.createElement('p');
        messageElement.textContent = `${message.role}: ${message.content}`;
        transcript.appendChild(messageElement);
      });

      // Scroll the transcript div to the bottom
      scrollToBottom(transcript);
    });
  </script>

</body>
</html>
